name: SecuCore-Engine CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-test-scan:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout source code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2) Install build + security tools
      - name: Install Build and Security Tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential cmake ninja-build \
            clang clang-tidy cppcheck \
            pkg-config wget gnupg

      # Optional: install ccache to speed up repeated builds (uncomment if desired)
      # - name: Install ccache
      #   run: sudo apt-get install -y ccache

      # 3) Clean previous build (important! avoids stale CMakeCache from other paths)
      - name: Clean previous build (avoid stale CMake cache)
        run: |
          rm -rf build

      # 4) Configure CMake (generate build system + compile_commands.json)
      - name: Configure CMake
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            ${CMAKE_PREFIX_FLAGS:-}

      # If your project depends on Drogon or other locally-installed libs,
      # set the CMake flags via the CMAKE_PREFIX_FLAGS secret/variable. Example:
      # -DDrogon_DIR=/usr/local/lib/cmake/Drogon
      # To pass them inline, replace ${CMAKE_PREFIX_FLAGS:-} with:
      # -DDrogon_DIR=/usr/local/lib/cmake/Drogon
      #
      # Prefer using repository secrets or job env if you don't want to hardcode paths.

      # 5) Build project
      - name: Build
        run: |
          cmake --build build -- -j$(nproc)

      # 6) Run tests (if any)
      - name: Run tests
        run: |
          if [ -d build ] && [ -f build/CTestTestfile.cmake ]; then
            ctest --test-dir build --output-on-failure
          else
            echo "No CTest tests found, skipping."
          fi

      # 7) Run cppcheck (SAST #1)
      - name: Run cppcheck
        run: |
          if [ -d src ]; then
            cppcheck \
              --enable=all \
              --std=c++17 \
              --inline-suppr \
              --suppress=missingIncludeSystem \
              --error-exitcode=1 \
              src include || true
          else
            echo "No src directory found, skipping cppcheck."
          fi

      # 8) Run clang-tidy (SAST #2)
      - name: Run clang-tidy
        run: |
          # ensure compile_commands.json exists
          if [ ! -f build/compile_commands.json ]; then
            echo "compile_commands.json not found, reconfiguring build to generate it..."
            cmake -S . -B build -G Ninja -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          fi

          if [ -d src ]; then
            # get list of translation units
            find src -name '*.cpp' > clang-tidy-files.txt || true

            while read -r file; do
              [ -z "$file" ] && continue
              echo "Running clang-tidy on $file"
              # -p build tells clang-tidy to read compile commands from build/
              clang-tidy "$file" --warnings-as-errors='*' -p build || true
            done < clang-tidy-files.txt
          else
            echo "No src directory found, skipping clang-tidy."
          fi

      # 9) Secret scanning - Gitleaks
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source . --no-git -v

      # 10) Install Trivy (latest) for dependency / FS scan
      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget gnupg
          wget -qO- https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo gpg --dearmor -o /usr/share/keyrings/trivy.gpg
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb generic main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      # 11) Trivy filesystem scan: flags HIGH+CRITICAL issues
      - name: Run Trivy filesystem scan
        run: |
          trivy fs . --exit-code 1 --severity CRITICAL,HIGH

